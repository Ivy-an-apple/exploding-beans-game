<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爆炸豆小游戏</title>
    <style>
        /* 登录/注册页面样式 */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .auth-container h2 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .auth-form {
            display: flex;
            flex-direction: column;
        }
        .auth-form input {
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .auth-form button {
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .auth-form button:hover {
            background-color: #45a049;
        }
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
        }
        .auth-toggle a {
            color: #4CAF50;
            text-decoration: none;
        }
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        .error-message {
            color: #f44336;
            text-align: center;
            margin: 10px 0;
        }
        .success-message {
            color: #4CAF50;
            text-align: center;
            margin: 10px 0;
        }
        .user-info {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .user-info button {
            padding: 5px 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .user-info button:hover {
            background-color: #d32f2f;
        }
        .hidden {
            display: none !important;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .game-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .game-info p {
            margin: 5px 0;
        }
        .beans-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .bean {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .bean:hover {
            transform: scale(1.05);
        }
        .bean.closed {
            background-color: #ddd;
            color: transparent;
        }
        .bean.closed:hover {
            background-color: #ccc;
        }
        .bean.exploding {
            background-color: #f44336;
            color: white;
        }
        .bean.lucky {
            background-color: #ffeb3b;
            color: #333;
        }
        .bean.halving {
            background-color: #2196f3;
            color: white;
        }
        .bean.dark {
            background-color: #673ab7;
            color: white;
        }
        .bean.normal {
            background-color: #4CAF50;
            color: white;
        }
        .control-panel {
            margin: 20px 0;
            text-align: center;
        }
        .control-panel input {
            padding: 10px;
            font-size: 16px;
            width: 100px;
            margin-right: 10px;
        }
        .control-panel button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .control-panel button:hover {
            background-color: #45a049;
        }
        .control-panel button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .control-panel button#end-btn {
            background-color: #f44336;
        }
        .control-panel button#end-btn:hover {
            background-color: #d32f2f;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            text-align: center;
        }
        .result h2 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .history {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .history h3 {
            margin-bottom: 10px;
        }
        .history ul {
            list-style-type: none;
        }
        .history li {
            margin: 5px 0;
            padding: 5px;
            background-color: #fff;
            border-radius: 3px;
        }
        
        /* 侧边栏样式 */
        #sidebar {
            width: 250px;
            background-color: #333;
            color: white;
            padding: 20px;
            height: 100vh;
            position: fixed;
        }
        #sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #4CAF50;
        }
        #sidebar ul {
            list-style: none;
            padding: 0;
        }
        #sidebar li {
            margin-bottom: 10px;
        }
        #sidebar a {
            display: block;
            padding: 12px;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #sidebar a:hover {
            background-color: #555;
        }
        #sidebar li:last-child {
            margin-top: 40px;
        }
        
        /* 主内容区域样式 */
        #main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        .page {
            min-height: 80vh;
        }
        .page.active {
            display: block;
        }
        
        /* 游戏卡片样式 */
        .game-card {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .game-card:hover {
            transform: translateY(-5px);
        }
        
        /* 充值选项样式 */
        .recharge-option {
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .recharge-option:hover {
            border-color: #4CAF50;
            background-color: #f9f9f9;
        }
        .recharge-option.selected {
            border-color: #4CAF50;
            background-color: #e8f5e8;
        }
    </style>
</head>
<body>
    <!-- 登录/注册页面 -->
    <div id="login-container" class="auth-container">
        <h2>用户登录</h2>
        <div class="auth-form">
            <input type="text" id="login-phone" placeholder="请输入手机号码">
            <input type="password" id="login-password" placeholder="请输入密码">
            <div style="text-align: right; margin-bottom: 10px;">
                <a href="#" id="to-forgot-password">忘记密码？</a>
            </div>
            <button id="login-btn">登录</button>
            <div class="auth-toggle">
                还没有账号？<a href="#" id="to-register">立即注册</a>
            </div>
            <div id="login-error" class="error-message hidden"></div>
        </div>
    </div>
    
    <!-- 忘记密码页面 -->
    <div id="forgot-password-container" class="auth-container hidden">
        <h2>找回密码</h2>
        <div class="auth-form">
            <input type="text" id="forgot-phone" placeholder="请输入手机号码">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="verification-code" placeholder="请输入验证码" style="flex: 1;">
                <button id="send-code-btn">发送验证码</button>
            </div>
            <input type="password" id="new-password" placeholder="请输入新密码">
            <input type="password" id="confirm-new-password" placeholder="请确认新密码">
            <button id="reset-password-btn">重置密码</button>
            <div class="auth-toggle">
                想起密码了？<a href="#" id="to-login-from-forgot">立即登录</a>
            </div>
            <div id="forgot-error" class="error-message hidden"></div>
            <div id="forgot-success" class="success-message hidden"></div>
        </div>
    </div>
    
    <!-- 注册页面 -->
    <div id="register-container" class="auth-container hidden">
        <h2>用户注册</h2>
        <div class="auth-form">
            <input type="text" id="register-phone" placeholder="请输入手机号码">
            <input type="password" id="register-password" placeholder="请输入密码">
            <input type="password" id="register-confirm-password" placeholder="请确认密码">
            <button id="register-btn">注册</button>
            <div class="auth-toggle">
                已有账号？<a href="#" id="to-login">立即登录</a>
            </div>
            <div id="register-error" class="error-message hidden"></div>
            <div id="register-success" class="success-message hidden"></div>
        </div>
    </div>
    
    <!-- 主应用容器 -->
    <div id="app-container" class="hidden" style="display: flex; min-height: 100vh; background-color: #f0f0f0;">
        <!-- 侧边栏导航菜单 -->
        <div id="sidebar" style="width: 250px; background-color: #333; color: white; padding: 20px; height: 100vh; position: fixed;">
            <h2 style="text-align: center; margin-bottom: 30px; color: #4CAF50;">游戏平台</h2>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 10px;">
                    <a href="#" class="nav-link" data-target="game-center" style="display: block; padding: 12px; color: white; text-decoration: none; border-radius: 4px; transition: background-color 0.3s;">游戏中心</a>
                </li>
                <li style="margin-bottom: 10px;">
                    <a href="#" class="nav-link" data-target="personal-account" style="display: block; padding: 12px; color: white; text-decoration: none; border-radius: 4px; transition: background-color 0.3s;">个人账户</a>
                </li>
                <li style="margin-bottom: 10px;">
                    <a href="#" class="nav-link" data-target="recharge-center" style="display: block; padding: 12px; color: white; text-decoration: none; border-radius: 4px; transition: background-color 0.3s;">充值中心</a>
                </li>
                <li style="margin-bottom: 10px; display: none;" id="admin-menu">
                    <a href="#" class="nav-link" data-target="user-center" style="display: block; padding: 12px; color: white; text-decoration: none; border-radius: 4px; transition: background-color 0.3s;">用户中心</a>
                </li>
                <li style="margin-bottom: 10px; display: none;" id="analytics-menu">
                    <a href="#" class="nav-link" data-target="analytics-center" style="display: block; padding: 12px; color: white; text-decoration: none; border-radius: 4px; transition: background-color 0.3s;">数据分析中心</a>
                </li>
                <li style="margin-top: 40px;">
                    <a href="#" id="logout-link" style="display: block; padding: 12px; color: white; text-decoration: none; border-radius: 4px; transition: background-color 0.3s;">退出登录</a>
                </li>
            </ul>
        </div>
        
        <!-- 主内容区域 -->
        <div id="main-content" style="flex: 1; margin-left: 250px; padding: 20px;">
            <!-- 游戏中心页面 -->
            <div id="game-center" class="page active">
                <h1 style="color: #333;">游戏中心</h1>
                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <div class="game-card" style="flex: 1; padding: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: transform 0.3s;">
                        <h3>爆炸豆小游戏</h3>
                        <p>经典的爆炸豆游戏，考验运气和胆量</p>
                        <button id="play-exploding-beans" style="margin-top: 20px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">开始游戏</button>
                    </div>
                </div>
            </div>
            
            <!-- 个人账户页面 -->
            <div id="personal-account" class="page hidden">
                <h1 style="color: #333;">个人账户</h1>
                <div style="background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px;">
                    <h2>基本信息</h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                        <div>
                            <p><strong>用户名：</strong><span id="pa-user-name">-</span></p>
                            <p><strong>手机号码：</strong><span id="pa-user-phone">-</span></p>
                            <p><strong>注册时间：</strong><span id="pa-registered-at">-</span></p>
                            <p><strong>注册天数：</strong><span id="pa-registered-days">-</span> 天</p>
                        </div>
                        <div>
                            <p><strong>年龄段：</strong><span id="pa-age-range">-</span></p>
                            <p><strong>账户余额：</strong><span id="pa-user-balance" style="font-size: 18px; font-weight: bold; color: #4CAF50;">-</span> 元</p>
                            <p><strong>总充值：</strong><span id="pa-total-recharge">-</span> 元</p>
                            <p><strong>总获利：</strong><span id="pa-total-profit">-</span> 元</p>
                        </div>
                    </div>
                    <div style="margin-top: 30px;">
                        <h3>年龄设置</h3>
                        <select id="age-range-select" style="padding: 8px; margin-top: 10px;">
                            <option value="18-25">18-25岁</option>
                            <option value="26-35">26-35岁</option>
                            <option value="36-45">36-45岁</option>
                            <option value="46-55">46-55岁</option>
                            <option value="56+">56岁以上</option>
                        </select>
                        <button id="save-age-btn" style="margin-left: 10px; padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">保存</button>
                    </div>
                </div>
            </div>
            
            <!-- 充值中心页面 -->
            <div id="recharge-center" class="page hidden">
                <h1 style="color: #333;">充值中心</h1>
                <div style="background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px;">
                    <h2>充值优惠</h2>
                    <p style="color: #ff9800; font-weight: bold; margin-top: 10px;">活动：充多少送多少！</p>
                    <div style="margin-top: 30px;">
                        <h3>选择充值金额</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                            <button class="recharge-option" data-amount="50" style="padding: 20px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s;">50元<br><small>实际到账：100元</small></button>
                            <button class="recharge-option" data-amount="100" style="padding: 20px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s;">100元<br><small>实际到账：200元</small></button>
                            <button class="recharge-option" data-amount="200" style="padding: 20px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s;">200元<br><small>实际到账：400元</small></button>
                            <button class="recharge-option" data-amount="500" style="padding: 20px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s;">500元<br><small>实际到账：1000元</small></button>
                        </div>
                        <div style="margin-top: 30px;">
                            <h3>自定义金额</h3>
                            <input type="number" id="custom-recharge-amount" min="10" max="10000" placeholder="请输入充值金额" style="padding: 10px; width: 200px; margin-top: 10px;">
                            <button id="custom-recharge-btn" style="margin-left: 10px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">充值</button>
                            <p style="margin-top: 10px; color: #666;">实际到账：<span id="actual-amount">0</span>元</p>
                        </div>
                        <div id="recharge-qr-code" class="hidden" style="margin-top: 30px; text-align: center;">
                            <h3>扫码充值</h3>
                            <div id="recharge-qr" style="margin: 20px 0;">
                                <!-- 二维码将通过JS生成 -->
                            </div>
                            <button id="confirm-recharge-center-btn" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">确认充值</button>
                            <button id="cancel-recharge-center-btn" style="margin-left: 10px; padding: 10px 20px; background-color: #9e9e9e; color: white; border: none; border-radius: 5px; cursor: pointer;">取消</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 管理员用户中心页面 -->
            <div id="user-center" class="page hidden">
                <h1 style="color: #333;">用户中心</h1>
                <div style="background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px;">
                    <h2>用户列表</h2>
                    <div id="uc-user-list" style="max-height: 500px; overflow-y: auto; margin-top: 20px;">
                        <!-- 用户列表将通过JS生成 -->
                    </div>
                </div>
                <!-- 用户详情模态框 -->
                <div id="user-detail-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background-color: #fff; border-radius: 10px; padding: 30px; width: 500px; max-width: 90%;">
                        <h3 id="modal-user-name">用户详情</h3>
                        <div id="user-detail-content" style="margin-top: 20px;">
                            <!-- 用户详情将通过JS生成 -->
                        </div>
                        <div style="margin-top: 30px; text-align: right;">
                            <button id="close-modal-btn" style="padding: 10px 20px; background-color: #9e9e9e; color: white; border: none; border-radius: 5px; cursor: pointer;">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据分析中心页面 -->
            <div id="analytics-center" class="page hidden">
                <h1 style="color: #333;">数据分析中心</h1>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px;">
                    <div style="background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px;">
                        <h3>年龄分布</h3>
                        <div id="age-distribution" style="margin-top: 20px;">
                            <!-- 年龄分布图表将通过JS生成 -->
                        </div>
                    </div>
                    <div style="background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px;">
                        <h3>充值情况</h3>
                        <div id="recharge-stats" style="margin-top: 20px;">
                            <!-- 充值情况图表将通过JS生成 -->
                        </div>
                    </div>
                    <div style="background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; grid-column: 1 / -1;">
                        <h3>游戏数据统计</h3>
                        <div id="game-stats" style="margin-top: 20px;">
                            <!-- 游戏数据统计将通过JS生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 爆炸豆游戏页面 -->
            <div id="exploding-beans-game" class="page hidden">
                <h1 style="color: #4CAF50; text-align: center;">爆炸豆小游戏</h1>
                <div class="game-info">
                    <p>游戏规则：</p>
                    <p>· 豆子总数：20颗</p>
                    <p>· 2颗爆炸豆（游戏结束，奖励清0）</p>
                    <p>· 1颗幸运豆（下一颗奖励翻3倍，若为负面豆，则失去翻三倍效果，在负面效果生效后，增加4元）</p>
                    <p>· 1颗减半豆（当前总收益除以2，向下取整到整数元）</p>
                    <p>· 1颗黑暗豆（当前-20，可为负数）</p>
                    <p>· 15颗普通豆（获得基础奖励）</p>
                    <p>· 收取门票：15元，前3抽若抽到炸弹则免门票</p>
                    <p>门票不计入初始收益，最后结算扣除，所有收益均为整数元。</p>
                </div>
                
                <!-- 实时收益显示 -->
                <div class="profit-display" style="text-align: center; margin: 10px 0; padding: 15px; background-color: #f9f9f9; border-radius: 5px;">
                    <h3>当前收益</h3>
                    <p>总收益：<span id="current-total-reward">0</span> 元</p>
                    <p>已抽取：<span id="current-drawn-count">0</span> 颗</p>
                    <p>剩余：<span id="current-remaining-count">20</span> 颗</p>
                </div>
                
                <div class="control-panel">
                    <button id="start-btn">开始游戏</button>
                    <div id="batch-draw" class="hidden">
                        <label for="batch-count">批量抽取颗数：</label>
                        <input type="number" id="batch-count" min="1" max="20" value="3">
                        <button id="batch-draw-btn">批量抽取</button>
                    </div>
                    <button id="end-btn" disabled>结束游戏</button>
                    <button id="reset-btn" disabled>重新开始</button>
                    <button id="back-to-game-center" style="margin-left: 10px; padding: 10px 20px; background-color: #9e9e9e; color: white; border: none; border-radius: 5px; cursor: pointer;">返回游戏中心</button>
                </div>
                <div id="game-status" style="text-align: center; margin: 10px 0;">
                    请点击开始游戏按钮
                </div>
                
                <div class="beans-container" id="beans-container">
                    <!-- 豆子将通过JS生成 -->
                </div>
                
                <div class="result" id="result">
                    <h2>游戏结果</h2>
                    <p id="total-reward">总收益：0元</p>
                    <p id="ticket-fee">门票：15元</p>
                    <p id="final-reward">最终收益：-15元</p>
                </div>
                
                <div class="history" id="history">
                    <h3>抽取历史</h3>
                    <ul id="history-list">
                        <!-- 历史记录将通过JS动态生成 -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 用户数据存储
        let users = [];
        let currentUser = null;
        let localStorageAvailable = true;
        
        // 尝试从 localStorage 获取数据
        try {
            users = JSON.parse(localStorage.getItem('gameUsers')) || [];
            currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        } catch (e) {
            console.error('localStorage 不可用，使用内存存储：', e);
            localStorageAvailable = false;
            users = [];
            currentUser = null;
        }
        
        // 验证码存储
        let verificationCodes = {};
        
        // 确保存在管理员账户
        function ensureAdminAccount() {
            const adminExists = users.some(user => user.role === 'admin');
            if (!adminExists) {
                const adminUser = {
                    id: Date.now(),
                    phone: '10086',
                    password: 'admin123',
                    role: 'admin',
                    name: '管理员',
                    balance: 999999, // 管理员余额无限
                    registeredAt: new Date().toISOString(),
                    rechargeRecords: [],
                    gameRecords: [],
                    status: 'active',
                    ageRange: '26-35'
                };
                users.push(adminUser);
                if (localStorageAvailable) {
                    try {
                        localStorage.setItem('gameUsers', JSON.stringify(users));
                    } catch (e) {
                        console.error('localStorage 不可用，无法保存管理员账户：', e);
                        localStorageAvailable = false;
                    }
                }
                console.log('管理员账户已生成：手机号码 10086，密码 admin123');
            }
        }
        
        // 初始化管理员账户
        ensureAdminAccount();
        
        // 游戏配置
        const gameConfig = {
            totalBeans: 20,
            explodingBeans: 2,
            luckyBeans: 1,
            halvingBeans: 1,
            darkBeans: 1,
            normalBeans: 15,
            ticketFee: 15,
            freeTicketThreshold: 3
        };
        
        // 奖励配置
        const rewardConfig = [
            { range: [1, 5], baseReward: 2, luckyReward: 4 },
            { range: [6, 11], baseReward: 5, luckyReward: 4 },
            { range: [12, 14], baseReward: 7, luckyReward: 3 },
            { range: [15, 15], baseReward: 10, luckyReward: 3 }
        ];
        
        // 游戏状态
        let gameState = {
            beans: [],
            drawnBeans: [],
            totalReward: 0,
            normalBeanCount: 0,
            luckyMultiplier: 1,
            gameOver: false,
            freeTicket: false,
            history: [],
            gameStarted: false,
            drawnCount: 0
        };
        
        // 页面初始化
        function initPage() {
            // 检查是否已登录
            if (currentUser) {
                showApp();
            } else {
                showLoginPage();
            }
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('register-container').classList.add('hidden');
            document.getElementById('forgot-password-container').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        // 显示注册页面
        function showRegisterPage() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('register-container').classList.remove('hidden');
            document.getElementById('forgot-password-container').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        // 显示忘记密码页面
        function showForgotPasswordPage() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('register-container').classList.add('hidden');
            document.getElementById('forgot-password-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        // 显示应用
        function showApp() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('register-container').classList.add('hidden');
            document.getElementById('forgot-password-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // 显示游戏中心页面
            showPage('game-center');
            
            // 检查是否为管理员，显示相应菜单
            if (currentUser.role === 'admin') {
                document.getElementById('admin-menu').style.display = 'block';
                document.getElementById('analytics-menu').style.display = 'block';
            } else {
                document.getElementById('admin-menu').style.display = 'none';
                document.getElementById('analytics-menu').style.display = 'none';
            }
            
            // 更新个人账户信息
            updatePersonalAccountInfo();
        }
        
        // 显示页面
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });
            
            // 显示选中页面
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('active');
        }
        
        // 计算注册天数
        function getRegisteredDays(registeredAt) {
            const now = new Date();
            const registeredDate = new Date(registeredAt);
            const diffTime = Math.abs(now - registeredDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // 计算总充值金额
        function getTotalRecharge(rechargeRecords) {
            return (rechargeRecords || []).reduce((total, record) => total + record.amount, 0);
        }
        
        // 计算总获利
        function getTotalProfit(gameRecords) {
            return (gameRecords || []).reduce((total, record) => total + record.finalReward, 0);
        }
        
        // 更新个人账户信息
        function updatePersonalAccountInfo() {
            if (currentUser) {
                document.getElementById('pa-user-name').textContent = currentUser.name || '用户';
                document.getElementById('pa-user-phone').textContent = currentUser.phone || '-';
                document.getElementById('pa-registered-at').textContent = new Date(currentUser.registeredAt).toLocaleString() || '-';
                document.getElementById('pa-registered-days').textContent = getRegisteredDays(currentUser.registeredAt) || 0;
                document.getElementById('pa-age-range').textContent = currentUser.ageRange || '-';
                document.getElementById('pa-user-balance').textContent = currentUser.balance || 0;
                document.getElementById('pa-total-recharge').textContent = getTotalRecharge(currentUser.rechargeRecords) || 0;
                document.getElementById('pa-total-profit').textContent = getTotalProfit(currentUser.gameRecords) || 0;
                
                // 设置年龄选择
                if (currentUser.ageRange) {
                    document.getElementById('age-range-select').value = currentUser.ageRange;
                }
            }
        }
        
        // 保存年龄设置
        function saveAgeRange() {
            const ageRange = document.getElementById('age-range-select').value;
            if (currentUser) {
                currentUser.ageRange = ageRange;
                // 更新用户列表中的年龄
                const userIndex = users.findIndex(user => user.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].ageRange = ageRange;
                    if (localStorageAvailable) {
                        try {
                            localStorage.setItem('gameUsers', JSON.stringify(users));
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        } catch (e) {
                            console.error('localStorage 不可用，无法保存年龄设置：', e);
                            localStorageAvailable = false;
                        }
                    }
                }
                // 更新显示
                document.getElementById('pa-age-range').textContent = ageRange;
                alert('年龄设置保存成功');
            }
        }
        
        // 登录函数
        function login() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            
            // 验证输入
            if (!phone || !password) {
                errorElement.textContent = '请输入手机号码和密码';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // 查找用户
            const user = users.find(user => user.phone === phone && user.password === password);
            if (user) {
                // 检查用户状态
                if (user.status === 'banned') {
                    errorElement.textContent = '您的账户已被封号';
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // 登录成功
                currentUser = user;
                if (localStorageAvailable) {
                    try {
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    } catch (e) {
                        console.error('localStorage 不可用，无法保存当前用户：', e);
                        localStorageAvailable = false;
                    }
                }
                errorElement.classList.add('hidden');
                showApp();
            } else {
                // 登录失败
                errorElement.textContent = '手机号码或密码错误';
                errorElement.classList.remove('hidden');
            }
        }
        
        // 注册函数
        function register() {
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-error');
            const successElement = document.getElementById('register-success');
            
            // 验证输入
            if (!phone || !password || !confirmPassword) {
                errorElement.textContent = '请填写所有必填字段';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 验证手机号码格式
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                errorElement.textContent = '请输入正确的手机号码';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 验证密码长度
            if (password.length < 6) {
                errorElement.textContent = '密码长度至少为6位';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 验证密码是否一致
            if (password !== confirmPassword) {
                errorElement.textContent = '两次输入的密码不一致';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 检查用户是否已存在
            if (users.some(user => user.phone === phone)) {
                errorElement.textContent = '该手机号码已注册';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 注册成功，创建新用户
            const newUser = {
                id: Date.now(),
                phone: phone,
                password: password,
                role: 'user',
                name: `用户${phone.slice(-4)}`,
                balance: 30, // 新用户初始30元余额
                registeredAt: new Date().toISOString(),
                rechargeRecords: [],
                gameRecords: [],
                status: 'active',
                ageRange: '18-25' // 默认年龄
            };
            
            users.push(newUser);
            if (localStorageAvailable) {
                try {
                    localStorage.setItem('gameUsers', JSON.stringify(users));
                } catch (e) {
                    console.error('localStorage 不可用，无法保存用户数据：', e);
                    localStorageAvailable = false;
                }
            }
            
            // 显示成功信息
            errorElement.classList.add('hidden');
            successElement.textContent = '注册成功，请登录';
            successElement.classList.remove('hidden');
            
            // 清空输入
            document.getElementById('register-phone').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm-password').value = '';
            
            // 3秒后跳转到登录页面
            setTimeout(showLoginPage, 3000);
        }
        
        // 退出登录
        function logout() {
            currentUser = null;
            if (localStorageAvailable) {
                try {
                    localStorage.removeItem('currentUser');
                } catch (e) {
                    console.error('localStorage 不可用：', e);
                    localStorageAvailable = false;
                }
            }
            showLoginPage();
        }
        
        // 生成验证码
        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // 发送验证码
        function sendVerificationCode() {
            const phone = document.getElementById('forgot-phone').value;
            const errorElement = document.getElementById('forgot-error');
            const sendCodeBtn = document.getElementById('send-code-btn');
            
            // 验证手机号码
            if (!phone) {
                errorElement.textContent = '请输入手机号码';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                errorElement.textContent = '请输入正确的手机号码';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // 检查用户是否存在
            const userExists = users.some(user => user.phone === phone);
            if (!userExists) {
                errorElement.textContent = '该手机号码未注册';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // 生成验证码
            const code = generateVerificationCode();
            verificationCodes[phone] = {
                code: code,
                expireTime: Date.now() + 5 * 60 * 1000 // 5分钟过期
            };
            
            // 模拟发送验证码
            console.log(`验证码已发送到 ${phone}，验证码为：${code}`);
            
            // 显示成功信息
            errorElement.classList.add('hidden');
            // 在页面上显示验证码
            const successElement = document.getElementById('forgot-success');
            successElement.textContent = `验证码已发送，验证码为：${code}（测试环境）`;
            successElement.classList.remove('hidden');
            alert(`验证码已发送，验证码为：${code}（测试环境，实际会发送到手机）`);
            
            // 禁用发送按钮60秒
            let countdown = 60;
            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = `${countdown}秒后重发`;
            
            const timer = setInterval(() => {
                countdown--;
                sendCodeBtn.textContent = `${countdown}秒后重发`;
                if (countdown <= 0) {
                    clearInterval(timer);
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = '发送验证码';
                }
            }, 1000);
        }
        
        // 重置密码
        function resetPassword() {
            const phone = document.getElementById('forgot-phone').value;
            const code = document.getElementById('verification-code').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const errorElement = document.getElementById('forgot-error');
            const successElement = document.getElementById('forgot-success');
            
            // 验证输入
            if (!phone || !code || !newPassword || !confirmPassword) {
                errorElement.textContent = '请填写所有字段';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 验证手机号码
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                errorElement.textContent = '请输入正确的手机号码';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 验证验证码
            const storedCode = verificationCodes[phone];
            if (!storedCode || storedCode.code !== code) {
                errorElement.textContent = '验证码错误';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            if (Date.now() > storedCode.expireTime) {
                errorElement.textContent = '验证码已过期';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 验证密码
            if (newPassword.length < 6) {
                errorElement.textContent = '密码长度至少为6位';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorElement.textContent = '两次输入的密码不一致';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }
            
            // 查找用户并重置密码
            const userIndex = users.findIndex(user => user.phone === phone);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                if (localStorageAvailable) {
                    try {
                        localStorage.setItem('gameUsers', JSON.stringify(users));
                    } catch (e) {
                        console.error('localStorage 不可用，无法保存密码修改：', e);
                        localStorageAvailable = false;
                    }
                }
                
                // 显示成功信息
                errorElement.classList.add('hidden');
                successElement.textContent = '密码重置成功，请登录';
                successElement.classList.remove('hidden');
                
                // 清空输入
                document.getElementById('forgot-phone').value = '';
                document.getElementById('verification-code').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
                
                // 删除验证码
                delete verificationCodes[phone];
                
                // 3秒后跳转到登录页面
                setTimeout(showLoginPage, 3000);
            } else {
                errorElement.textContent = '用户不存在';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
            }
        }
        
        // 充值相关
        let selectedRechargeAmount = 0;
        
        // 选择充值金额
        function selectRechargeAmount(amount) {
            selectedRechargeAmount = parseInt(amount);
            // 更新实际到账金额
            document.getElementById('actual-amount').textContent = selectedRechargeAmount * 2;
            // 显示充值二维码
            showRechargeQRCode();
        }
        
        // 自定义充值
        function customRecharge() {
            const amount = parseInt(document.getElementById('custom-recharge-amount').value);
            if (amount < 10 || amount > 10000) {
                alert('充值金额必须在10-10000元之间');
                return;
            }
            selectedRechargeAmount = amount;
            // 更新实际到账金额
            document.getElementById('actual-amount').textContent = selectedRechargeAmount * 2;
            // 显示充值二维码
            showRechargeQRCode();
        }
        
        // 显示充值二维码
        function showRechargeQRCode() {
            document.getElementById('recharge-qr-code').classList.remove('hidden');
            const qrCodeDiv = document.getElementById('recharge-qr');
            // 使用稳定的QR码生成API
            const qrText = `游戏充值 ${selectedRechargeAmount} 元，实际到账 ${selectedRechargeAmount * 2} 元`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
            qrCodeDiv.innerHTML = `<img src="${qrCodeUrl}" alt="充值二维码" style="width: 200px; height: 200px;">`;
        }
        
        // 确认充值
        function confirmRechargeCenter() {
            if (selectedRechargeAmount <= 0) {
                alert('请选择充值金额');
                return;
            }
            
            // 计算实际到账金额（充多少送多少）
            const actualAmount = selectedRechargeAmount * 2;
            
            // 更新余额
            if (currentUser.role !== 'admin') {
                currentUser.balance = (currentUser.balance || 0) + actualAmount;
                
                // 记录充值记录
                const rechargeRecord = {
                    id: Date.now(),
                    amount: selectedRechargeAmount,
                    actualAmount: actualAmount,
                    timestamp: new Date().toISOString(),
                    type: 'recharge'
                };
                currentUser.rechargeRecords = currentUser.rechargeRecords || [];
                currentUser.rechargeRecords.push(rechargeRecord);
                
                // 更新用户列表中的余额和充值记录
                const userIndex = users.findIndex(user => user.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].balance = currentUser.balance;
                    users[userIndex].rechargeRecords = currentUser.rechargeRecords;
                    if (localStorageAvailable) {
                        try {
                            localStorage.setItem('gameUsers', JSON.stringify(users));
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        } catch (e) {
                            console.error('localStorage 不可用，无法保存充值记录：', e);
                            localStorageAvailable = false;
                        }
                    }
                }
                
                // 更新个人账户信息
                updatePersonalAccountInfo();
            }
            
            // 隐藏充值二维码
            document.getElementById('recharge-qr-code').classList.add('hidden');
            
            alert(`充值成功！实际到账 ${actualAmount} 元`);
        }
        
        // 取消充值
        function cancelRechargeCenter() {
            document.getElementById('recharge-qr-code').classList.add('hidden');
            selectedRechargeAmount = 0;
        }
        
        // 生成用户列表
        function generateUserList() {
            const userListDiv = document.getElementById('uc-user-list');
            userListDiv.innerHTML = '';
            
            // 过滤掉管理员账户
            const nonAdminUsers = users.filter(user => user.role !== 'admin');
            
            if (nonAdminUsers.length === 0) {
                userListDiv.innerHTML = '<p>暂无用户</p>';
                return;
            }
            
            nonAdminUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.style.padding = '10px';
                userDiv.style.marginBottom = '10px';
                userDiv.style.backgroundColor = '#fff';
                userDiv.style.borderRadius = '3px';
                userDiv.style.borderLeft = '4px solid ' + (user.status === 'active' ? '#4CAF50' : '#f44336');
                userDiv.style.cursor = 'pointer';
                userDiv.style.transition = 'background-color 0.3s';
                userDiv.addEventListener('click', () => showUserDetail(user));
                
                const registeredDays = getRegisteredDays(user.registeredAt);
                const totalRecharge = getTotalRecharge(user.rechargeRecords);
                const totalProfit = getTotalProfit(user.gameRecords);
                
                userDiv.innerHTML = `
                    <h4>${user.name} (${user.phone})</h4>
                    <p>注册天数：${registeredDays} 天</p>
                    <p>年龄段：${user.ageRange || '-'}</p>
                    <p>账户余额：${user.balance} 元</p>
                    <p>总充值：${totalRecharge} 元</p>
                    <p>总获利：${totalProfit} 元</p>
                    <p>状态：<span style="color: ${user.status === 'active' ? '#4CAF50' : '#f44336'};">${user.status === 'active' ? '正常' : '已封号'}</span></p>
                `;
                
                userListDiv.appendChild(userDiv);
            });
        }
        
        // 显示用户详情
        function showUserDetail(user) {
            document.getElementById('user-detail-modal').classList.remove('hidden');
            document.getElementById('modal-user-name').textContent = `${user.name} (${user.phone})`;
            
            const contentDiv = document.getElementById('user-detail-content');
            const registeredDays = getRegisteredDays(user.registeredAt);
            const totalRecharge = getTotalRecharge(user.rechargeRecords);
            const totalProfit = getTotalProfit(user.gameRecords);
            
            contentDiv.innerHTML = `
                <p><strong>用户名：</strong>${user.name}</p>
                <p><strong>手机号码：</strong>${user.phone}</p>
                <p><strong>注册时间：</strong>${new Date(user.registeredAt).toLocaleString()}</p>
                <p><strong>注册天数：</strong>${registeredDays} 天</p>
                <p><strong>年龄段：</strong>${user.ageRange || '-'}</p>
                <p><strong>账户余额：</strong>${user.balance} 元</p>
                <p><strong>总充值：</strong>${totalRecharge} 元</p>
                <p><strong>总获利：</strong>${totalProfit} 元</p>
                <p><strong>状态：</strong><span style="color: ${user.status === 'active' ? '#4CAF50' : '#f44336'};">${user.status === 'active' ? '正常' : '已封号'}</span></p>
                <p><strong>充值次数：</strong>${user.rechargeRecords ? user.rechargeRecords.length : 0} 次</p>
                <p><strong>游戏次数：</strong>${user.gameRecords ? user.gameRecords.length : 0} 次</p>
            `;
        }
        
        // 关闭用户详情
        function closeUserDetail() {
            document.getElementById('user-detail-modal').classList.add('hidden');
        }
        
        // 生成数据分析
        function generateAnalytics() {
            // 生成年龄分布
            generateAgeDistribution();
            // 生成充值情况
            generateRechargeStats();
            // 生成游戏数据统计
            generateGameStats();
        }
        
        // 生成年龄分布
        function generateAgeDistribution() {
            const ageDistributionDiv = document.getElementById('age-distribution');
            
            // 统计各年龄段用户数量
            const ageCounts = {
                '18-25': 0,
                '26-35': 0,
                '36-45': 0,
                '46-55': 0,
                '56+': 0
            };
            
            users.forEach(user => {
                if (user.role !== 'admin' && user.ageRange) {
                    ageCounts[user.ageRange]++;
                }
            });
            
            // 生成柱状图
            let html = '<div style="display: flex; gap: 10px; align-items: flex-end; height: 200px;">';
            Object.entries(ageCounts).forEach(([age, count]) => {
                const height = count > 0 ? (count / Math.max(...Object.values(ageCounts))) * 180 : 20;
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="width: 80%; height: ${height}px; background-color: #4CAF50; border-radius: 5px 5px 0 0;"></div>
                        <span style="margin-top: 5px;">${age}</span>
                        <span>${count}人</span>
                    </div>
                `;
            });
            html += '</div>';
            
            ageDistributionDiv.innerHTML = html;
        }
        
        // 生成充值情况
        function generateRechargeStats() {
            const rechargeStatsDiv = document.getElementById('recharge-stats');
            
            // 统计总充值金额
            let totalRecharge = 0;
            let totalUsers = 0;
            users.forEach(user => {
                if (user.role !== 'admin') {
                    totalUsers++;
                    totalRecharge += getTotalRecharge(user.rechargeRecords);
                }
            });
            
            const avgRecharge = totalUsers > 0 ? (totalRecharge / totalUsers).toFixed(2) : 0;
            
            rechargeStatsDiv.innerHTML = `
                <p><strong>总充值金额：</strong>${totalRecharge} 元</p>
                <p><strong>充值用户数：</strong>${totalUsers} 人</p>
                <p><strong>平均充值金额：</strong>${avgRecharge} 元</p>
                <div style="margin-top: 20px; height: 150px; background-color: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: #4CAF50;">${totalRecharge}</div>
                        <div style="color: #666;">总充值金额（元）</div>
                    </div>
                </div>
            `;
        }
        
        // 生成游戏数据统计
        function generateGameStats() {
            const gameStatsDiv = document.getElementById('game-stats');
            
            // 统计游戏数据
            let totalGames = 0;
            let totalPlayers = 0;
            let totalProfit = 0;
            users.forEach(user => {
                if (user.role !== 'admin' && user.gameRecords && user.gameRecords.length > 0) {
                    totalPlayers++;
                    totalGames += user.gameRecords.length;
                    totalProfit += getTotalProfit(user.gameRecords);
                }
            });
            
            const avgGamesPerPlayer = totalPlayers > 0 ? (totalGames / totalPlayers).toFixed(2) : 0;
            const avgProfitPerGame = totalGames > 0 ? (totalProfit / totalGames).toFixed(2) : 0;
            
            gameStatsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <div style="padding: 20px; background-color: #f9f9f9; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${totalGames}</div>
                        <div style="color: #666;">总游戏次数</div>
                    </div>
                    <div style="padding: 20px; background-color: #f9f9f9; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196f3;">${totalPlayers}</div>
                        <div style="color: #666;">游戏玩家数</div>
                    </div>
                    <div style="padding: 20px; background-color: #f9f9f9; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${avgGamesPerPlayer}</div>
                        <div style="color: #666;">人均游戏次数</div>
                    </div>
                    <div style="padding: 20px; background-color: #f9f9f9; border-radius: 5px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">${avgProfitPerGame}</div>
                        <div style="color: #666;">平均每局收益</div>
                    </div>
                </div>
            `;
        }
        
        // 更新实时收益显示
        function updateProfitDisplay() {
            document.getElementById('current-total-reward').textContent = gameState.totalReward;
            document.getElementById('current-drawn-count').textContent = gameState.drawnBeans.length;
            document.getElementById('current-remaining-count').textContent = gameState.beans.length - gameState.drawnBeans.length;
        }
        
        // 初始化游戏
        function initGame() {
            // 重置游戏状态
            gameState = {
                beans: [],
                drawnBeans: [],
                totalReward: 0,
                normalBeanCount: 0,
                luckyMultiplier: 1,
                gameOver: false,
                freeTicket: false,
                history: [],
                gameStarted: false,
                drawnCount: 0
            };
            
            // 生成豆子
            generateBeans();
            
            // 渲染豆子
            renderBeans();
            
            // 重置UI
            document.getElementById('result').style.display = 'none';
            document.getElementById('history-list').innerHTML = '';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('end-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;
            document.getElementById('batch-draw').classList.add('hidden');
            document.getElementById('game-status').textContent = '请点击开始游戏按钮';
            
            // 更新实时收益显示
            updateProfitDisplay();
        }
        
        // 生成豆子
        function generateBeans() {
            const beans = [];
            
            // 添加爆炸豆
            for (let i = 0; i < gameConfig.explodingBeans; i++) {
                beans.push({ type: 'exploding', value: 0 });
            }
            
            // 添加幸运豆
            for (let i = 0; i < gameConfig.luckyBeans; i++) {
                beans.push({ type: 'lucky', value: 0 });
            }
            
            // 添加减半豆
            for (let i = 0; i < gameConfig.halvingBeans; i++) {
                beans.push({ type: 'halving', value: 0 });
            }
            
            // 添加黑暗豆
            for (let i = 0; i < gameConfig.darkBeans; i++) {
                beans.push({ type: 'dark', value: -20 });
            }
            
            // 添加普通豆
            for (let i = 0; i < gameConfig.normalBeans; i++) {
                beans.push({ type: 'normal', value: 0 });
            }
            
            // 打乱豆子顺序
            for (let i = beans.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [beans[i], beans[j]] = [beans[j], beans[i]];
            }
            
            gameState.beans = beans;
        }
        
        // 渲染豆子
        function renderBeans() {
            const container = document.getElementById('beans-container');
            container.innerHTML = '';
            
            gameState.beans.forEach((bean, index) => {
                const beanElement = document.createElement('div');
                beanElement.className = `bean closed`;
                beanElement.dataset.index = index;
                
                // 添加点击事件
                beanElement.addEventListener('click', () => {
                    if (gameState.gameStarted && !gameState.gameOver && !gameState.drawnBeans.includes(index)) {
                        drawBean(index);
                    }
                });
                
                container.appendChild(beanElement);
            });
        }
        
        // 抽取豆子
        function drawBean(index) {
            if (gameState.gameOver || gameState.drawnBeans.includes(index)) return;
            
            // 标记为已抽取
            gameState.drawnBeans.push(index);
            gameState.drawnCount++;
            
            const bean = gameState.beans[index];
            const beanElement = document.querySelector(`.bean[data-index="${index}"]`);
            
            // 根据豆子类型处理
            switch (bean.type) {
                case 'exploding':
                    handleExplodingBean(beanElement);
                    break;
                case 'lucky':
                    handleLuckyBean(beanElement);
                    break;
                case 'halving':
                    handleHalvingBean(beanElement);
                    break;
                case 'dark':
                    handleDarkBean(beanElement);
                    break;
                case 'normal':
                    handleNormalBean(beanElement);
                    break;
            }
            
            // 更新实时收益显示
            updateProfitDisplay();
            
            // 检查游戏是否结束
            if (!gameState.gameOver && gameState.drawnBeans.length >= gameState.beans.length) {
                endGame();
            }
        }
        
        // 处理爆炸豆
        function handleExplodingBean(beanElement) {
            beanElement.className = 'bean exploding';
            beanElement.textContent = '爆炸';
            
            // 检查是否在前3抽
            if (gameState.drawnCount <= gameConfig.freeTicketThreshold) {
                gameState.freeTicket = true;
            }
            
            // 游戏结束，收益清0
            gameState.totalReward = 0;
            gameState.gameOver = true;
            
            // 更新游戏状态
            document.getElementById('game-status').textContent = '游戏结束！抽到了爆炸豆，收益清0';
            document.getElementById('end-btn').disabled = true;
            document.getElementById('reset-btn').disabled = false;
            
            // 结束游戏
            endGame();
        }
        
        // 处理幸运豆
        function handleLuckyBean(beanElement) {
            beanElement.className = 'bean lucky';
            beanElement.textContent = '幸运';
            
            // 幸运豆效果：下一颗奖励翻3倍
            gameState.luckyMultiplier = 3;
            
            // 添加到历史记录
            gameState.history.push('抽到了幸运豆，下一颗奖励翻3倍');
            updateHistory();
            
            // 更新游戏状态
            document.getElementById('game-status').textContent = '抽到了幸运豆，下一颗奖励翻3倍';
        }
        
        // 处理减半豆
        function handleHalvingBean(beanElement) {
            beanElement.className = 'bean halving';
            beanElement.textContent = '减半';
            
            // 计算减半后的收益
            const halvedReward = Math.floor(gameState.totalReward / 2);
            const difference = gameState.totalReward - halvedReward;
            gameState.totalReward = halvedReward;
            
            // 检查是否有幸运倍率
            if (gameState.luckyMultiplier > 1) {
                // 失去幸运效果
                gameState.luckyMultiplier = 1;
                // 增加4元
                gameState.totalReward += 4;
            }
            
            // 添加到历史记录
            gameState.history.push(`抽到了减半豆，收益减少${difference}元`);
            updateHistory();
            
            // 更新游戏状态
            document.getElementById('game-status').textContent = '抽到了减半豆，收益减半';
        }
        
        // 处理黑暗豆
        function handleDarkBean(beanElement) {
            beanElement.className = 'bean dark';
            beanElement.textContent = '-20';
            
            // 扣除20元
            gameState.totalReward -= 20;
            
            // 检查是否有幸运倍率
            if (gameState.luckyMultiplier > 1) {
                // 失去幸运效果
                gameState.luckyMultiplier = 1;
                // 增加4元
                gameState.totalReward += 4;
            }
            
            // 添加到历史记录
            gameState.history.push('抽到了黑暗豆，扣除20元');
            updateHistory();
            
            // 更新游戏状态
            document.getElementById('game-status').textContent = '抽到了黑暗豆，扣除20元';
        }
        
        // 处理普通豆
        function handleNormalBean(beanElement) {
            beanElement.className = 'bean normal';
            
            // 增加普通豆计数
            gameState.normalBeanCount++;
            
            // 根据普通豆计数计算奖励
            let reward = 0;
            for (const config of rewardConfig) {
                if (gameState.normalBeanCount >= config.range[0] && gameState.normalBeanCount <= config.range[1]) {
                    reward = config.baseReward;
                    break;
                }
            }
            
            // 应用幸运倍率
            const finalReward = reward * gameState.luckyMultiplier;
            gameState.totalReward += finalReward;
            
            // 重置幸运倍率
            gameState.luckyMultiplier = 1;
            
            // 显示奖励
            beanElement.textContent = `+${finalReward}`;
            
            // 添加到历史记录
            gameState.history.push(`抽到了普通豆，获得${finalReward}元`);
            updateHistory();
            
            // 更新游戏状态
            document.getElementById('game-status').textContent = `抽到了普通豆，获得${finalReward}元`;
        }
        
        // 更新历史记录
        function updateHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            gameState.history.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                historyList.appendChild(li);
            });
        }
        
        // 开始游戏
        function startGame() {
            // 检查余额
            if (currentUser.role !== 'admin' && currentUser.balance < gameConfig.ticketFee) {
                alert('余额不足，无法开始游戏');
                return;
            }
            
            // 初始化游戏
            initGame();
            
            // 更新游戏状态
            gameState.gameStarted = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('end-btn').disabled = false;
            document.getElementById('batch-draw').classList.remove('hidden');
            document.getElementById('game-status').textContent = '游戏开始，请点击豆子抽取';
        }
        
        // 结束游戏
        function endGame() {
            if (!gameState.gameStarted) return;
            
            // 计算最终收益
            let finalReward = gameState.totalReward;
            let ticketFee = gameConfig.ticketFee;
            
            // 检查是否免门票
            if (gameState.freeTicket) {
                ticketFee = 0;
            } else if (currentUser.role === 'admin') {
                // 管理员免门票
                ticketFee = 0;
            } else {
                // 扣除门票
                finalReward -= ticketFee;
            }
            
            // 更新余额
            if (currentUser.role !== 'admin') {
                currentUser.balance += finalReward;
                
                // 记录游戏记录
                const gameRecord = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    totalReward: gameState.totalReward,
                    finalReward: finalReward,
                    ticketFee: ticketFee,
                    drawnCount: gameState.drawnBeans.length,
                    freeTicket: gameState.freeTicket
                };
                currentUser.gameRecords = currentUser.gameRecords || [];
                currentUser.gameRecords.push(gameRecord);
                
                // 更新用户列表
                const userIndex = users.findIndex(user => user.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].balance = currentUser.balance;
                    users[userIndex].gameRecords = currentUser.gameRecords;
                    if (localStorageAvailable) {
                        try {
                            localStorage.setItem('gameUsers', JSON.stringify(users));
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        } catch (e) {
                            console.error('localStorage 不可用，无法保存游戏记录：', e);
                            localStorageAvailable = false;
                        }
                    }
                }
                
                // 更新个人账户信息
                updatePersonalAccountInfo();
            }
            
            // 显示结果
            document.getElementById('result').style.display = 'block';
            document.getElementById('total-reward').textContent = `总收益：${gameState.totalReward}元`;
            document.getElementById('ticket-fee').textContent = `门票：${ticketFee}元`;
            document.getElementById('final-reward').textContent = `最终收益：${finalReward}元`;
            
            // 更新游戏状态
            gameState.gameOver = true;
            document.getElementById('end-btn').disabled = true;
            document.getElementById('reset-btn').disabled = false;
            document.getElementById('game-status').textContent = '游戏结束';
        }
        
        // 批量抽取
        function batchDraw() {
            const batchCount = parseInt(document.getElementById('batch-count').value);
            if (batchCount < 1 || batchCount > 20) {
                alert('请输入1-20之间的数字');
                return;
            }
            
            if (!gameState.gameStarted || gameState.gameOver) {
                alert('游戏未开始或已结束');
                return;
            }
            
            // 计算剩余豆子
            const remainingBeans = gameState.beans.map((_, index) => index).filter(index => !gameState.drawnBeans.includes(index));
            const actualCount = Math.min(batchCount, remainingBeans.length);
            
            // 随机抽取
            for (let i = 0; i < actualCount; i++) {
                if (gameState.gameOver) break;
                const randomIndex = Math.floor(Math.random() * remainingBeans.length);
                const beanIndex = remainingBeans[randomIndex];
                remainingBeans.splice(randomIndex, 1);
                drawBean(beanIndex);
            }
        }
        
        // 返回游戏中心
        function backToGameCenter() {
            showPage('game-center');
        }
        
        // 事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded事件触发');
            // 初始化页面
            initPage();
            console.log('initPage执行完成');
            
            // 安全添加事件监听器的函数
            function addEventListenerIfExists(elementId, event, callback) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, callback);
                    console.log('为', elementId, '添加', event, '事件监听器');
                } else {
                    console.warn('元素', elementId, '不存在，无法添加事件监听器');
                }
            }
            
            // 检查DOM元素是否存在
            console.log('login-btn元素:', document.getElementById('login-btn'));
            console.log('register-btn元素:', document.getElementById('register-btn'));
            console.log('logout-link元素:', document.getElementById('logout-link'));
            
            // 登录/注册相关事件
            addEventListenerIfExists('login-btn', 'click', login);
            addEventListenerIfExists('register-btn', 'click', register);
            addEventListenerIfExists('logout-link', 'click', logout);
            
            // 页面切换事件
            addEventListenerIfExists('to-register', 'click', function(e) {
                e.preventDefault();
                showRegisterPage();
            });
            addEventListenerIfExists('to-login', 'click', function(e) {
                e.preventDefault();
                showLoginPage();
            });
            addEventListenerIfExists('to-forgot-password', 'click', function(e) {
                e.preventDefault();
                showForgotPasswordPage();
            });
            addEventListenerIfExists('to-login-from-forgot', 'click', function(e) {
                e.preventDefault();
                showLoginPage();
            });
            
            // 忘记密码相关事件
            addEventListenerIfExists('send-code-btn', 'click', sendVerificationCode);
            addEventListenerIfExists('reset-password-btn', 'click', resetPassword);
            
            // 导航菜单事件
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.dataset.target;
                    if (target) {
                        showPage(target);
                        
                        // 如果是数据分析中心，生成数据
                        if (target === 'analytics-center') {
                            generateAnalytics();
                        }
                        
                        // 如果是用户中心，生成用户列表
                        if (target === 'user-center') {
                            generateUserList();
                        }
                    }
                });
            });
            
            // 个人账户事件
            addEventListenerIfExists('save-age-btn', 'click', saveAgeRange);
            
            // 充值中心事件
            const rechargeOptions = document.querySelectorAll('.recharge-option');
            rechargeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    selectRechargeAmount(this.dataset.amount);
                });
            });
            addEventListenerIfExists('custom-recharge-btn', 'click', customRecharge);
            addEventListenerIfExists('confirm-recharge-center-btn', 'click', confirmRechargeCenter);
            addEventListenerIfExists('cancel-recharge-center-btn', 'click', cancelRechargeCenter);
            
            // 游戏中心事件
            addEventListenerIfExists('play-exploding-beans', 'click', function() {
                showPage('exploding-beans-game');
                initGame();
            });
            
            // 游戏相关事件
            addEventListenerIfExists('start-btn', 'click', startGame);
            addEventListenerIfExists('end-btn', 'click', endGame);
            addEventListenerIfExists('reset-btn', 'click', initGame);
            addEventListenerIfExists('batch-draw-btn', 'click', batchDraw);
            addEventListenerIfExists('back-to-game-center', 'click', backToGameCenter);
            
            // 管理员用户中心事件
            addEventListenerIfExists('close-modal-btn', 'click', closeUserDetail);
            
            console.log('所有事件监听器已添加');
        });
    </script>
</body>
</html>